<div class="facturas-container">
  <div class="facturas-header">
    <h1>Facturas</h1>
    <button class="btn btn-primary" (click)="openForm()">Nueva Factura</button>
  </div>

  <div class="facturas-filtros form-row" style="margin-bottom: 1.5rem;">
    <div class="form-group col-md-4">
      <label for="buscadorCliente">Buscar por Cliente</label>
      <div class="d-flex" style="gap: 0.5rem;">
        <input id="buscadorCliente" type="text" class="form-control" [(ngModel)]="busquedaCliente"
          (keyup.enter)="buscarFacturasPorCliente()" placeholder="Nombre del cliente" autocomplete="off">
        <button class="btn btn-sm btn-primary" (click)="buscarFacturasPorCliente()">Buscar</button>
      </div>
    </div>
    <div class="form-group col-md-4">
      <label for="buscadorUsuario">Buscar por Usuario</label>
      <div class="d-flex" style="gap: 0.5rem;">
        <input id="buscadorUsuario" type="text" class="form-control" [(ngModel)]="busquedaUsuario"
          (keyup.enter)="buscarFacturasPorUsuario()" placeholder="Nombre de usuario" autocomplete="off">
        <button class="btn btn-sm btn-primary" (click)="buscarFacturasPorUsuario()">Buscar</button>
      </div>
    </div>
  </div>

  @if (error()) {
  <div class="alert alert-danger">
    {{ error() }}
  </div>
  }

  @if (loading()) {
  <div class="loading-spinner">
    <div class="spinner-border"></div>
    <p>Cargando facturas...</p>
  </div>
  }

  @if (!loading()) {
  @if (facturas().length === 0) {
  <div class="alert alert-info">
    No hay facturas registradas. Crea una nueva haciendo clic en "Nueva Factura".
  </div>
  } @else {
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Usuario</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (factura of facturas(); track factura.id) {
        <tr>
          <td>{{ formatDate(factura.fecha) }}</td>
          <td>{{ getClienteNombre(factura.clienteId) }}</td>
          <td>{{ getUsuarioNombre(factura.usuarioId) }}</td>
          <td>
            ${{ (factura.total ?? 0).toFixed(2) }}
          </td>
          <td>
            @if (!factura.activa) {
            <span class="badge badge-success">Activa</span>
            } @else {
            <span class="badge badge-secondary">Cancelada</span>
            }
          </td>
          <td>
            <div class="btn-group">
              <button class="btn btn-sm btn-info" (click)="viewDetalles(factura)">Ver</button>
              <button class="btn btn-sm btn-danger" (click)="cancelarFacturaVisual(factura)">Cancelar</button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }
  }

  @if (showForm()) {
  <div class="modal-overlay">
    <div class="modal-container modal-xl">
      <div class="modal-header">
        <h2>{{ editingFactura() ? 'Editar Factura' : 'Nueva Factura' }}</h2>
        <button class="btn-close" (click)="closeForm()">&times;</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="facturaForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="cliente">Cliente</label>
              <select id="cliente" class="form-control" formControlName="clienteId" required>
                <option [ngValue]="null">Seleccione un cliente</option>
                <option *ngFor="let cliente of clientes()" [value]="cliente.id">{{ cliente.nombre }}</option>
              </select>
            </div>

            <div class="form-group col-md-6">
              <label for="usuarioId">Usuario</label>
              <input type="text" class="form-control"
                [value]="getUsuarioNombre(facturaForm.get('usuarioId')?.value || 0)" readonly>
              <input type="hidden" formControlName="usuarioId">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="agregar-producto-section">
                <h3>Agregar Productos</h3>

                <div class="form-group">
                  <label>Producto</label>
                  <select [(ngModel)]="selectedProductoId" class="form-control" [ngModelOptions]="{standalone: true}"
                          (change)="onProductoSeleccionado()">
                    <option [ngValue]="null">Seleccione un producto</option>
                    @for (producto of productos(); track producto.id) {
                    <option [value]="producto.id">{{ producto.nombre }} - ${{ producto.precio.toFixed(2) }}</option>
                    }
                  </select>
                </div>

                <div class="form-group">
                  <label>Cantidad</label>
                  <input type="number" [(ngModel)]="selectedCantidad" class="form-control"
                    [ngModelOptions]="{standalone: true}" min="1" placeholder="1">
                </div>

                <button type="button" class="btn btn-success btn-block" (click)="agregarProductoALista()"
                  [disabled]="!selectedProductoId || !selectedCantidad || selectedCantidad <= 0 || selectedPrecioUnitario <= 0">
                  Agregar Producto
                </button>
              </div>
            </div>
            <div class="col-md-6">
              <div class="productos-agregados-section">
                <h3>Productos Agregados</h3>

                @if (productosAgregados.length === 0) {
                <div class="alert alert-info">
                  No hay productos agregados aún
                </div>
                } @else {
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm">
                    <thead class="thead-light">
                      <tr>
                        <th>Producto</th>
                        <th>Cant.</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                        <th>Acción</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (producto of productosAgregados; track $index) {
                      <tr>
                        <td>{{ getProductoNombre(producto.productoId) }}</td>
                        <td>{{ producto.cantidad }}</td>
                        <td>${{ producto.precioUnitario.toFixed(2) }}</td>
                        <td>${{ (producto.cantidad * producto.precioUnitario).toFixed(2) }}</td>
                        <td>
                          <button type="button" class="btn btn-sm btn-danger" (click)="removerProductoDeLista($index)">
                            &times;
                          </button>
                        </td>
                      </tr>
                      }
                    </tbody>
                    <tfoot>
                      <tr class="table-active">
                        <td colspan="3"><strong>Total:</strong></td>
                        <td><strong>${{ calcularTotalLista().toFixed(2) }}</strong></td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                }
              </div>
            </div>
          </div>

          <div class="form-actions mt-3">
            <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="facturaForm.invalid || productosAgregados.length === 0">
              {{ editingFactura() ? 'Actualizar' : 'Crear' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  @if (showDetalles() !== null && selectedFactura()) {
  <div class="modal-overlay">
    <div class="modal-container modal-lg">
      <div class="modal-header">
        <h2>Detalles de Factura #{{ selectedFactura()?.id }}</h2>
        <button class="btn-close" (click)="closeDetalles()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="factura-info">
          <div class="factura-header">
            <div class="factura-title">
              <h3>Abarrotes el Zorro</h3>
              <p>Factura #{{ selectedFactura()?.id }}</p>
              <p>Fecha: {{ fechaFacturaSeleccionada }}</p>
            </div>

            <div class="factura-cliente">
              <h4>Cliente</h4>
              <p>{{ getClienteNombre(selectedFactura()?.clienteId || 0) }}</p>
            </div>
          </div>

          <div class="factura-detalles">
            <h4>Productos</h4>

            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  @if (selectedFactura()?.detalles && selectedFactura()?.detalles?.length) {
                  @for (detalle of selectedFactura()?.detalles || []; track detalle.id) {
                  <tr>
                    <td>{{ getProductoNombre(detalle.productoId) }}</td>
                    <td>{{ detalle.cantidad }}</td>
                    <td>${{ detalle.precioUnitario.toFixed(2) }}</td>
                    <td>${{ (detalle.cantidad * detalle.precioUnitario).toFixed(2) }}</td>
                  </tr>
                  }
                  } @else {
                  <tr>
                    <td colspan="4" class="text-center">No hay detalles disponibles</td>
                  </tr>
                  }
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-right"><strong>Total:</strong></td>
                    <td><strong>${{ totalFacturaSeleccionada }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="factura-footer">
            <p>Atendido por: {{ getUsuarioNombre(selectedFactura()?.usuarioId || 0) }}</p>
            <p>¡Gracias por su compra!</p>
          </div>
        </div>

        <div class="factura-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDetalles()">Cerrar</button>
          <button type="button" class="btn btn-primary" (click)="imprimirFactura()">Imprimir</button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
